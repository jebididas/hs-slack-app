<html>
  <head>
  <link rel="stylesheet" href="main.css">
  <link href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,700,900,400italic,700italic,900italic" rel="stylesheet" type="text/css">
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>  
  </head>
  <body>
  <div class="channel-cont">
    <div class="channel-dropdown dropdown">
      <button class="btn btn-xs btn-warning dropdown-toggle" type="button" id="channelDropdown" data-toggle="dropdown">
        general 
        <span class="caret"></span>
      </button>
      <ul id="dropdown-channel-menu" class="dropdown-menu" aria-labelledby="channelDropdown">
        <li><a href="#">No Channels</a></li>
      </ul>
    </div>
    <div class="channel-desc">Channel</div>
    <button id="oAuthLogin" class="btn btn-default btn-xs">
      <a target="_blank" href="https://slack.com/oauth/authorize?client_id=10392449395.10392827204?state=1a081084c53d5acd8737c8e1427bb958?redirect_uri=https://hs-slack.herokuapp.com/auth.html">Login</a>
    </button>
  </div> 
  <div class="slack-message">
    <div class="left">
      <img id="messageAvatar" class="message-img" src="slack-30.png">
    </div>
    <div class="center">
      <h3 class="message-title">HootBot</h3>
      <p class="message-details"></p>
    </div>
    <div class="right">
      <p class="message-time"></p>
    </div>
    <div class="clear"></div>
  </div>
  <button id="postToSlack" class="btn btn-default post-btn">Post to Channel</button>

    <script>
      // function getQuerystring (key) {
      //   key = key.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");      Old code
      //   var regex = new RegExp("[\\?&]"+key+"=([^]*)");
      //   var qs = regex.exec(location.search);
      //   return qs[1];
      // } 

      function getParameterByName(name) {  // This decodes and separates the URI into pieces
          name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
          var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
              results = regex.exec(location.search);
          return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      var slack_access_token = localStorage.getItem('slack_access_token');
      var slack_team_name = localStorage.getItem('slack_team_name');
      if(slack_access_token != undefined){
        $('#oAuthLogin').text(slack_team_name);
      }


        $.ajax({
          method: "GET",
          url: "https://slack.com/api/channels.list?token=" + localStorage.getItem('slack_access_token'),
          success: function(response) {
            console.log(response);
            $('#postToSlack').text('Post to ' + response.channels[0].name + ' channel');
            $('#dropdown-channel-menu').empty();
            response.channels.forEach(function(channel) {
              console.log(channel.id);
              $listItem = $('<li>');
              $listItem.append('<a id="' + channel.id + '" class="channelSelector" href="#">' + channel.name + '</a>');
              $($listItem).appendTo('#dropdown-channel-menu');
            });
            $('.channelSelector').on('click', function() {
              $('#channelDropdown').text($(this).text());
              $('#channelDropdown').append(' <span class="caret"></span>');
              $('#postToSlack').text('Post to ' + $(this).text() + ' channel');
              $(this).addClass('selectedChannel');
            });
            

            $('#postToSlack').on('click', function(event) {

              console.log('NEW CHANNEL: ' + $('.selectedChannel').attr('id'));
              $channel = $('.selectedChannel').attr('id');
              $message = encodeURIComponent(getParameterByName('message'));
              $url = "https://slack.com/api/chat.postMessage?token=" + localStorage.getItem('slack_access_token') 
                    + "&channel=" + $channel 
                    + "&text=" + $message 
                    + "&as_user=true"
                    + "&pretty=1";              
              event.preventDefault(); // To prevent following the link
             
              $.ajax({
                method: "POST",
                url: $url,
                success: function(response) {
                  console.log(response);
                  console.log($url);
                  console.log($message);
                  $('#postToSlack').remove();
                  $('.slack-message').empty();
                  $('.channel-cont').empty();
                  $('.slack-message').append('div').addClass('message-sent').text('Message sent!');
                }
              });        
            });
            
            $('.message-details').text(getParameterByName('message'));
            $('.message-time').text(getParameterByName('datetime'));            
          }
        })
        .done(function() {
        });       
       


    </script>

    
  </body>
</html>